{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes Avanzados - MOV-OS</title>
  <!-- Fuentes y CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * {
      color: #FFF !important;
    }
    /* Sobrescribe el color solo para la tabla de productos */
    table.top-products-table,
    table.top-products-table th,
    table.top-products-table td {
      color: #000 !important;
    }
    body {
      background-color: #000;
      color: #FFF;
      font-family: 'Cinzel', serif;
    }
    .card, .sidebar-card {
      background-color: #12161A !important;
      border: 1px solid #444E5A;
      margin-bottom: 1rem;
    }
    .card-header h4, .sidebar-card h5, .display-6 {
      color: #FFF !important;
      text-shadow: 0 0 5px #0099FF;
    }
    .card-header p, .small, label, .form-label {
      color: #CCC;
    }
    .list-group-item {
      background-color: #1F222B !important;
      color: #FFF;
      border: 1px solid #444E5A;
    }
    /* Filtros: inputs y selects en las secciones de fechas, top productos y gráfica de onda deberán mostrar texto negro */
    #global-filters input.form-control,
    #global-filters select.form-select,
    #topFilterForm input.form-control,
    #topFilterForm select.form-select,
    #waveTimeFilterForm input.form-control,
    #waveTimeFilterForm select.form-select {
      color: #000 !important;
    }
    /* Sobrescribir el color de las opciones en los selects */
    select.form-select option {
      color: #000 !important;
    }
    /* Scroll para la sección de producto */
    #product-results {
      max-height: 300px;
      overflow-y: auto;
    }
    /* Contenedor para el gráfico de onda */
    #waveChartContainer {
      position: relative;
      height: 250px; /* Altura reducida */
    }
    /* Sidebar siempre visible */
    #sidebar {
      background-color: #1F222B;
      border-right: 1px solid #444E5A;
      padding: 1rem;
    }
    #sidebar label {
      color: #FFF;
      margin-bottom: .5rem;
    }
    .toggle-indicator {
      margin-bottom: .5rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid py-3">
    <div class="row">
      <!-- Sidebar -->
      <aside id="sidebar" class="col-md-3 mb-3">
        <div class="sidebar-card p-3 mb-3">
          <h5>Indicadores</h5>
          <div class="form-check toggle-indicator">
            <input class="form-check-input" type="checkbox" id="toggleKPI" checked>
            <label class="form-check-label" for="toggleKPI">KPIs Generales</label>
          </div>
          <div class="form-check toggle-indicator">
            <input class="form-check-input" type="checkbox" id="toggleVentas" checked>
            <label class="form-check-label" for="toggleVentas">Detalle de Ventas</label>
          </div>
          <div class="form-check toggle-indicator">
            <input class="form-check-input" type="checkbox" id="toggleFormaPago" checked>
            <label class="form-check-label" for="toggleFormaPago">Ventas por Forma de Pago</label>
          </div>
          <div class="form-check toggle-indicator">
            <input class="form-check-input" type="checkbox" id="toggleTopProd" checked>
            <label class="form-check-label" for="toggleTopProd">Top Productos</label>
          </div>
          <div class="form-check toggle-indicator">
            <input class="form-check-input" type="checkbox" id="toggleProductoInfo" checked>
            <label class="form-check-label" for="toggleProductoInfo">Info. de Producto</label>
          </div>
          <div class="form-check toggle-indicator">
            <input class="form-check-input" type="checkbox" id="toggleOnda" checked>
            <label class="form-check-label" for="toggleOnda">Gráfico de Onda</label>
          </div>
        </div>
      </aside>
      <!-- Contenido Principal -->
      <main class="col-md-9">
        <!-- Filtro General -->
        <div class="card mb-3" id="global-filters">
          <div class="card-header">
            <h4>Filtro de Reporte</h4>
          </div>
          <div class="card-body">
            <form method="get" class="row gy-3 align-items-end">
              <div class="col-md-4">
                <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
                <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" value="{{ fecha_inicio|default:'' }}">
              </div>
              <div class="col-md-4">
                <label for="fecha_fin" class="form-label">Fecha de Fin</label>
                <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" value="{{ fecha_fin|default:'' }}">
              </div>
              <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Indicadores Avanzados: Información con IVA -->
        <div class="card mb-3" id="indicadores-avanzados">
          <div class="card-header">
            <h4>Indicadores Avanzados</h4>
            <p class="small">Información completa para la toma de decisiones</p>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <!-- Venta con IVA -->
              <div class="col-6 col-md-3 mb-3">
                <h5>Venta con IVA</h5>
                <p class="display-6">{{ ingreso_total|default:"0" }}</p>
                <p class="small">Total recaudado (con IVA)</p>
              </div>
              <!-- Venta sin IVA -->
              <div class="col-6 col-md-3 mb-3">
                <h5>Venta sin IVA</h5>
                <p class="display-6">{{ ingreso_total_sin_iva|default:"0" }}</p>
                <p class="small">Total sin IVA</p>
              </div>
              <!-- IVA Recaudado -->
              <div class="col-6 col-md-3 mb-3">
                <h5>IVA Recaudado</h5>
                <p class="display-6">{{ iva_total|default:"0" }}</p>
                <p class="small">Monto de IVA</p>
              </div>
              <!-- Ganancia Bruta -->
              <div class="col-6 col-md-3 mb-3">
                <h5>Ganancia Bruta</h5>
                <p class="display-6">{{ ganancia_bruta|default:"0" }}</p>
                <p class="small">(Venta sin IVA - Costo)</p>
              </div>
              <!-- Ganancia Líquida -->
              <div class="col-6 col-md-3 mb-3">
                <h5>Ganancia Líquida</h5>
                <p class="display-6">{{ ganancia_liquida|default:"0" }}</p>
                <p class="small">Ganancia Bruta menos Gastos</p>
              </div>
              <!-- Costo Total -->
              <div class="col-6 col-md-3 mb-3">
                <h5>Costo Total</h5>
                <p class="display-6">{{ costo_total|default:"0" }}</p>
                <p class="small">Inversión en Productos</p>
              </div>
              <!-- Transacciones -->
              <div class="col-6 col-md-3 mb-3">
                <h5>Transacciones</h5>
                <p class="display-6">{{ num_transacciones|default:"0" }}</p>
                <p class="small">Ventas Realizadas</p>
              </div>
            </div>
          </div>
        </div>
        <!-- Detalle de Ventas -->
        <div class="card mb-3" id="detalle-ventas">
          <div class="card-header">
            <h4>Detalle de Ventas</h4>
            <p class="small">Transacciones y promedios</p>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 col-md-4 mb-3">
                <h5>Ticket Promedio</h5>
                <p class="display-6">{{ ticket_promedio }}</p>
                <p class="small">Promedio por venta</p>
              </div>
              <div class="col-6 col-md-4 mb-3">
                <h5>Unidades Promedio</h5>
                <p class="display-6">{{ unidades_promedio }}</p>
                <p class="small">Unidades vendidas</p>
              </div>
              <div class="col-12 col-md-4 mb-3">
                <h5>Total Transacciones</h5>
                <p class="display-6">{{ num_transacciones }}</p>
                <p class="small">Ventas realizadas</p>
              </div>
            </div>
          </div>
        </div>
        <!-- Ventas por Forma de Pago -->
        <div class="card mb-3" id="forma-pago">
          <div class="card-header">
            <h4>Ventas por Forma de Pago</h4>
            <p class="small">Distribución según método de pago</p>
          </div>
          <div class="card-body text-center">
            <canvas id="chartSalesByPayment" width="800" height="400"></canvas>
          </div>
        </div>
        <!-- Top Productos Más Vendidos -->
        <div class="card mb-3" id="top-productos">
          <div class="card-header">
            <h4>Top Productos Más Vendidos</h4>
            <p class="small">Listado de productos con mayor cantidad vendida</p>
          </div>
          <div class="card-body">
            <form method="get" id="topFilterForm" class="row g-2 align-items-end justify-content-center mb-3">
              <div class="col-6 col-md-3">
                <input type="hidden" name="fecha_inicio" value="{{ fecha_inicio }}">
                <input type="hidden" name="fecha_fin" value="{{ fecha_fin }}">
                <label for="top" class="form-label small mb-0">Mostrar Top</label>
                <select name="top" id="top" class="form-select">
                  <option value="5" {% if filtro_top_actual == 5 %}selected{% endif %}>5</option>
                  <option value="10" {% if filtro_top_actual == 10 %}selected{% endif %}>10</option>
                  <option value="20" {% if filtro_top_actual == 20 %}selected{% endif %}>20</option>
                  <option value="30" {% if filtro_top_actual == 30 %}selected{% endif %}>30</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <button type="submit" class="btn btn-primary w-100">Actualizar</button>
              </div>
            </form>
            <div class="table-responsive">
              <table class="table table-striped table-hover top-products-table">
                <thead class="thead-dark">
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad Vendida</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in top_selling_products %}
                  <tr>
                    <td>{{ product.producto__nombre }}</td>
                    <td>{{ product.total_cantidad }}</td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="2" class="text-center">No hay datos disponibles.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Información de Producto -->
        <div class="card mb-3" id="producto-info">
          <div class="card-header">
            <h4>Información de Producto</h4>
            <p class="small">Busca un producto y obtén datos estadísticos:</p>
          </div>
          <div class="card-body">
            <form method="get" id="productSearchForm" class="row g-3 align-items-end">
              <div class="col-md-4">
                <label for="product_search" class="form-label">Buscar Producto</label>
                <input type="text" id="product_search" name="product_search" class="form-control" placeholder="Nombre, código, etc.">
              </div>
              <div class="col-md-3">
                <label for="prod_fecha_inicio" class="form-label">Fecha de Inicio</label>
                <input type="date" id="prod_fecha_inicio" name="prod_fecha_inicio" class="form-control">
              </div>
              <div class="col-md-3">
                <label for="prod_fecha_fin" class="form-label">Fecha de Fin</label>
                <input type="date" id="prod_fecha_fin" name="prod_fecha_fin" class="form-control">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Buscar</button>
              </div>
            </form>
            <!-- Resultados con scroll -->
            <div class="mt-4" id="product-results">
              <table class="table table-dark table-striped">
                <thead>
                  <tr>
                    <th>Mes con Mayor Venta</th>
                    <th>Cantidad Promedio Vendida</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td id="max-month">N/A</td>
                    <td id="avg-quantity">N/A</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="small mt-2">* La información se calculará de forma independiente al filtro general.</p>
          </div>
        </div>
        <!-- Gráfico de Onda: Ganancias vs Tiempo -->
        <div class="card mb-3" id="grafico-onda">
          <div class="card-header">
            <h4>Gráfico de Onda</h4>
            <p class="small">Comparativa de Ganancias (en pesos) vs Tiempo</p>
            <form id="waveTimeFilterForm" class="row g-2 align-items-end mt-2">
              <div class="col-auto">
                <label for="timeUnit" class="form-label small">Filtrar por:</label>
              </div>
              <div class="col-auto">
                <select name="timeUnit" id="timeUnit" class="form-select form-select-sm">
                  <option value="meses">Meses</option>
                  <option value="anios">Años</option>
                </select>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-primary btn-sm">Actualizar</button>
              </div>
            </form>
          </div>
          <div class="card-body">
            <div id="waveChartContainer">
              <canvas id="waveChart"></canvas>
            </div>
          </div>
        </div>
        <div class="text-center my-4">
          <a href="{% url 'report_dashboard' %}" class="btn btn-secondary">Volver al Dashboard de Reportes</a>
        </div>
      </main>
    </div>
  </div>
  <!-- Scripts: Bootstrap y Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // Toggle de indicadores
    document.getElementById('toggleKPI').addEventListener('change', function() {
      document.getElementById('kpis-general').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('toggleVentas').addEventListener('change', function() {
      document.getElementById('detalle-ventas').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('toggleFormaPago').addEventListener('change', function() {
      document.getElementById('forma-pago').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('toggleTopProd').addEventListener('change', function() {
      document.getElementById('top-productos').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('toggleProductoInfo').addEventListener('change', function() {
      document.getElementById('producto-info').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('toggleOnda').addEventListener('change', function() {
      document.getElementById('grafico-onda').style.display = this.checked ? 'block' : 'none';
    });
    
    // Gráfico de Barras: Ventas por Forma de Pago
    const ctxPayment = document.getElementById('chartSalesByPayment').getContext('2d');
    const paymentLabels = [{% for item in sales_by_payment_chart %}"{{ item.forma_pago }}",{% endfor %}];
    const paymentData = [{% for item in sales_by_payment_chart %}{{ item.total_monto }},{% endfor %}];
    new Chart(ctxPayment, {
      type: 'bar',
      data: {
        labels: paymentLabels,
        datasets: [{
          label: 'Ventas por Forma de Pago',
          data: paymentData,
          backgroundColor: [
            'rgba(0,208,255,0.7)',
            'rgba(75,192,192,0.7)',
            'rgba(255,206,86,0.7)',
            'rgba(255,99,132,0.7)'
          ],
          borderColor: [
            'rgba(0,208,255,1)',
            'rgba(75,192,192,1)',
            'rgba(255,206,86,1)',
            'rgba(255,99,132,1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        plugins: { legend: { position: 'top' } },
        scales: {
          x: { beginAtZero: true, ticks: { color: '#FFF' } },
          y: { ticks: { color: '#FFF' } }
        }
      }
    });
    
    // Gráfico de Onda: Ganancias vs Tiempo
    const ctxWave = document.getElementById('waveChart').getContext('2d');
    const waveLabels = {% if wave_labels %}[{% for label in wave_labels %}"{{ label }}",{% endfor %}]{% else %}["Enero","Febrero","Marzo","Abril","Mayo","Junio"]{% endif %};
    const waveGains = {% if wave_gains %}[{% for data in wave_gains %}{{ data }},{% endfor %}]{% else %}[1500000,2000000,1800000,2200000,2100000,2500000]{% endif %};
    new Chart(ctxWave, {
      type: 'line',
      data: {
        labels: waveLabels,
        datasets: [{
          label: 'Ganancias (CLP)',
          data: waveGains,
          borderColor: 'rgba(255,99,132,1)',
          backgroundColor: 'rgba(255,99,132,0.3)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        plugins: { legend: { position: 'top' } },
        scales: {
          y: { beginAtZero: true, ticks: { color: '#FFF' } },
          x: { ticks: { color: '#FFF' } }
        }
      }
    });
    
    // Filtro de periodo para gráfico de onda (ejemplo)
    document.getElementById('waveTimeFilterForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const selectedUnit = document.getElementById('timeUnit').value;
      alert('Filtro de tiempo actualizado: ' + selectedUnit);
      // Implementa actualización vía AJAX o recarga con parámetros según necesites.
    });
  </script>
</body>
</html>