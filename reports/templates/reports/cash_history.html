{% extends 'base.html' %}
{% load static %}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/reports.css' %}">
{% endblock %}
{% block content %}
<div class="container content-max">
    <h2 class="mb-4">Historial de Caja</h2>

    <!-- Sección de Filtros -->
    <form method="get" action="{% url 'reports:historial_caja' %}" class="row align-items-end mb-3 filtros-container">
        <div class="col-md-3">
            <label for="id_caja_filtro" class="form-label">ID Caja</label>
            <input type="number" class="form-control" id="id_caja_filtro" name="id_caja" value="{{ id_caja_filtro|default:'' }}" placeholder="Ej. 123">
        </div>
        <div class="col-md-3">
            <label for="cajero_filtro" class="form-label">Cajero</label>
            <input type="text" class="form-control" id="cajero_filtro" name="cajero" value="{{ cajero_filtro|default:'' }}" placeholder="Nombre de usuario">
        </div>
        <div class="col-md-3">
            <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio_filtro|default:'' }}">
        </div>
        <div class="col-md-3">
            <label for="fecha_fin" class="form-label">Fecha de Fin</label>
            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin_filtro|default:'' }}">
        </div>
        <div class="col-12 mt-3 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary me-2">Filtrar</button>
            <a href="{% url 'reports:historial_caja' %}" class="btn btn-secondary">Limpiar Filtros</a>
        </div>
    </form>

    <!-- Tabla de cajas -->
    {% if cajas %}
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="historial-caja">
            <thead class="thead-dark">
                <tr>
                    <th>ID Caja</th>
                    <th>Cajero</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Cierre</th>
                    <th>Total Ventas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for caja in cajas %}
                <tr {% if caja.estado == 'cerrada' %} class="row-link" style="cursor:pointer" data-href="{% url 'reports:caja_report' caja.id %}" {% endif %}>
                    <td>{{ caja.id }}</td>
                    <td>{{ caja.vendedor.username }}</td>
                    <td>{{ caja.apertura|date:"d/m/Y H:i" }}</td>
                    <td>
                        {% if caja.cierre %}
                            {{ caja.cierre|date:"d/m/Y H:i" }}
                        {% else %}
                            <em>Sin cerrar</em>
                        {% endif %}
                    </td>
                    <td>{{ caja.formatted_ventas_totales }}</td>
                    <td>
                        {% if caja.estado == 'abierta' %}
                            <span class="badge badge-success">Abierta</span>
                        {% elif caja.estado == 'cerrada' %}
                            <span class="badge badge-danger">Cerrada</span>
                        {% else %}
                            <span class="badge badge-secondary">{{ caja.estado|title }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if caja.estado == 'cerrada' %}
                            <a href="{% url 'reports:caja_report' caja.id %}" class="btn btn-sm btn-info">Ver Detalle</a>
                        {% else %}
                            <button type="button" class="btn btn-sm btn-warning btn-forzar-cierre" data-caja-id="{{ caja.id }}">Forzar Cierre</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No hay registros de caja disponibles.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Paginación omitida por brevedad -->
    {% else %}
    <p class="text-center">No hay registros de caja disponibles.</p>
    {% endif %}

    <div class="d-flex justify-content-between mt-3">
    {% url 'reports:report_dashboard' as back_href %}
    {% include 'partials/back_button.html' with href=back_href text='Volver al Dashboard de Reportes' %}
        <button type="button" class="btn btn-danger" onclick="limpiarHistorial()">Limpiar Historial</button>
    </div>
</div>

<script>
    function getMetaCSRF() {
        const meta = document.querySelector("meta[name='csrf-token']");
        return meta ? meta.getAttribute('content') : '';
    }
    function syncCSRFCookies() {
        const token = getMetaCSRF();
        if (!token) return;
        // Normaliza el cookie en rutas comunes para evitar duplicados con distinto valor
        const attrs = '; path=/; SameSite=Lax';
        document.cookie = `csrftoken=${encodeURIComponent(token)}${attrs}`;
        // Intenta también normalizar en rutas específicas usadas anteriormente
        document.cookie = `csrftoken=${encodeURIComponent(token)}; path=/reports; SameSite=Lax`;
        document.cookie = `csrftoken=${encodeURIComponent(token)}; path=/cashier; SameSite=Lax`;
    }
    function getCSRFToken() {
        // Preferimos el token de meta (coincide con el emitido por el servidor para esta vista)
        const meta = getMetaCSRF();
        if (meta) return meta;
        // Fallback: lee cookie
        const parts = (document.cookie || '').split(';');
        for (const p of parts) {
            const [name, ...rest] = p.trim().split('=');
            if (name === 'csrftoken') return decodeURIComponent(rest.join('='));
        }
        return '';
    }

    // Sincroniza cookies al cargar el script
    try { syncCSRFCookies(); } catch (e) { console.warn('CSRF sync error', e); }
    function forzarCierreCaja(cajaId) {
        if (!confirm("¿Estás seguro de que deseas forzar el cierre de la caja?")) return;
        fetch("/cashier/cerrar_caja/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({ caja_id: cajaId })
        })
        .then(async (response) => {
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                const text = await response.text();
                throw new Error(`HTTP ${response.status} - ${text.substring(0, 200)}...`);
            }
            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.error || `HTTP ${response.status}`);
            }
            alert("Caja cerrada correctamente.");
            location.reload();
        })
        .catch(err => {
            console.error("Error en forzarCierreCaja:", err);
            alert(`Error al cerrar la caja: ${err && err.message ? err.message : err}`);
        });
    }
    function limpiarHistorial() {
        if (!confirm("¿Estás seguro de que deseas limpiar el historial de cajas? Esto eliminará todos los registros.")) return;
        fetch("{% url 'reports:limpiar_historial_caja' %}", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Historial limpiado correctamente.");
                location.reload();
            } else {
                alert(data.error || "Error al limpiar el historial.");
            }
        })
        .catch(err => {
            console.error("Error en limpiarHistorial:", err);
            alert("Error al limpiar el historial.");
        });
    }
    // Delegamos eventos al cargar el DOM
    document.addEventListener('DOMContentLoaded', function() {
        // Click en filas cerradas para navegar
        document.querySelectorAll('tr.row-link').forEach(function(row) {
            row.addEventListener('click', function(ev) {
                const href = row.getAttribute('data-href');
                if (href) { window.location.href = href; }
            });
        });
        // Botones de forzar cierre (evita propagar para no activar el click de fila)
        document.querySelectorAll('button.btn-forzar-cierre').forEach(function(btn) {
            btn.addEventListener('click', function(ev) {
                ev.stopPropagation();
                const id = btn.getAttribute('data-caja-id');
                if (id) { forzarCierreCaja(id); }
            });
        });
    });
</script>
{% endblock %}